<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="connect-src 'self' https://wygndhtvmvtvonfzfzuu.supabase.co;">
  <title>{% if page.title %}{{ page.title | escape }}{% else %}{{ site.title | escape }}{% endif %}</title>
  <meta name="description" content="{% if page.excerpt %}{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">
  
  <link rel="stylesheet" href="{{ "/assets/main.css" | relative_url }}">
  <link rel="canonical" href="{{ page.url | replace:'index.html','' | absolute_url }}">
  
  {% if jekyll.environment == 'production' and site.google_analytics %}
    {% include google-analytics.html %}
  {% endif %}
</head>

<body>
  <header class="site-header">
    <div class="wrapper">
      <a class="site-title" href="{{ "/" | relative_url }}">{{ site.title | escape }}</a>
      
      <nav class="site-nav">
        <div class="trigger">
          {% for my_page in site.pages %}
            {% if my_page.title %}
              <a class="page-link" href="{{ my_page.url | relative_url }}">{{ my_page.title | escape }}</a>
            {% endif %}
          {% endfor %}
        </div>
      </nav>
    </div>
  </header>

  <main class="main-content">
    <div class="page-content">
      <div class="wrapper">
        {{ content }}
        
        {%- comment -%}
        评论系统（支持 giscus 与 utterances），仅在文章页面显示。当 site.comments_system 为 "giscus" 时使用 giscus 配置。
        在 `_config.yml` 中设置：comments_system: "giscus" 或 "utterances"
        {%- endcomment -%}

        {%- if page.date and page.path contains '_posts' -%}
          {%- if site.comments_system == 'giscus' -%}
            {%- if site.giscus_repo and site.giscus_repo != "" -%}
            <div id="comments" style="margin-top: 2rem;">
              <h3>留言</h3>
              <div id="giscus-container">
                <script src="https://giscus.app/client.js"
                  async
                  data-repo="{{ site.giscus_repo | escape }}"
                  {% if site.giscus_repo_id and site.giscus_repo_id != "" %}data-repo-id="{{ site.giscus_repo_id | escape }}"{% endif %}
                  {% if site.giscus_category and site.giscus_category != "" %}data-category="{{ site.giscus_category | escape }}"{% endif %}
                  {% if site.giscus_category_id and site.giscus_category_id != "" %}data-category-id="{{ site.giscus_category_id | escape }}"{% endif %}
                  data-mapping="{{ site.giscus_mapping | default: 'pathname' }}"
                  data-reactions-enabled="{{ site.giscus_reactions_enabled | default: '1' }}"
                  data-emit-metadata="{{ site.giscus_emit_metadata | default: '0' }}"
                  data-input-position="{{ site.giscus_input_position | default: 'bottom' }}"
                  data-theme="{{ site.giscus_theme | default: 'light' }}"
                  data-lang="{{ site.giscus_lang | default: 'zh-CN' }}"
                  crossorigin="anonymous"
                  ></script>
              </div>
            </div>
            {%- endif -%}
          {%- elsif site.comments_system == 'utterances' -%}
            {%- if site.utterances_repo and site.utterances_repo != "" -%}
            <div id="comments" style="margin-top: 2rem;">
              <h3>留言</h3>
              <div id="utterances-container"></div>
            </div>

            <script>
              (function() {
                var repo = '{{ site.utterances_repo | escape }}';
                if (!repo) return;
                var script = document.createElement('script');
                script.src = 'https://utteranc.es/client.js';
                script.async = true;
                script.setAttribute('repo', repo);
                script.setAttribute('issue-term', '{{ site.utterances_issue_term | default: "pathname" }}');
                script.setAttribute('theme', '{{ site.utterances_theme | default: "github-light" }}');
                script.crossOrigin = 'anonymous';
                var container = document.getElementById('utterances-container');
                if (container) container.appendChild(script);
              })();
            </script>
            {%- endif -%}
          {%- elsif site.comments_system == 'local' -%}
            <div id="comments" style="margin-top: 2rem;">
              <h3>留言（本地保存，仅在此设备可见）</h3>
              <div id="local-comments">
                <div id="local-comment-list" style="margin-bottom:1rem;"></div>
                <textarea id="local-comment-input" rows="4" style="width:100%;" placeholder="在此输入留言..."></textarea>
                <div style="margin-top:0.5rem; display:flex; gap:8px;">
                  <input id="local-comment-name" placeholder="署名（可选）" style="flex:0 0 200px;" />
                  <button id="local-comment-submit">提交留言</button>
                  <button id="local-comment-clear">清空所有本地留言</button>
                </div>
                <p style="color:#666; font-size:0.9rem; margin-top:0.5rem;">仅保存在你当前浏览器的本地存储中，别人访问不会看到。</p>
              </div>
            </div>

            <script>
              (function(){
                var storageKey = 'local_comments_' + location.pathname;
                function loadComments(){
                  try{
                    var raw = localStorage.getItem(storageKey);
                    return raw ? JSON.parse(raw) : [];
                  }catch(e){ return []; }
                }
                function saveComments(arr){
                  try{ localStorage.setItem(storageKey, JSON.stringify(arr)); }catch(e){}
                }
                function formatTime(ts){
                  var d = new Date(ts);
                  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0') + ' ' + String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
                }
                function render(){
                  var list = loadComments();
                  var container = document.getElementById('local-comment-list');
                  if(!container) return;
                  if(list.length === 0){ container.innerHTML = '<p style="color:#666;">还没有留言，写下你的第一条吧！</p>'; return; }
                  container.innerHTML = '';
                    list.forEach(function(item, idx){
                      var div = document.createElement('div');
                      div.className = 'comment-item';
                      var initials = item.name ? item.name.trim().slice(0,1).toUpperCase() : '匿';
                      var author = item.name ? escapeHtml(item.name) : '匿名';
                      div.innerHTML = '<div class="meta"><div class="meta-left"><div class="avatar-circle">'+initials+'</div><div><div class="comment-author">'+author+'</div><div class="comment-time">'+formatTime(item.ts)+'</div></div></div></div>' +
                                    '<div class="comment-content">'+escapeHtml(item.text)+'</div>' +
                                    '<div style="margin-top:6px;"><button data-idx="'+idx+'" class="local-delete btn-ghost">删除</button></div>';
                      container.appendChild(div);
                    });
                  Array.from(container.querySelectorAll('.local-delete')).forEach(function(btn){
                    btn.addEventListener('click', function(){
                      var i = Number(this.getAttribute('data-idx'));
                      var arr = loadComments(); arr.splice(i,1); saveComments(arr); render();
                    });
                  });
                }
                function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
                document.getElementById('local-comment-submit').addEventListener('click', function(){
                  var text = document.getElementById('local-comment-input').value.trim();
                  var name = document.getElementById('local-comment-name').value.trim();
                  if(!text) return alert('留言不能为空');
                  var arr = loadComments();
                  arr.unshift({name: name, text: text, ts: Date.now()});
                  saveComments(arr); document.getElementById('local-comment-input').value = '';
                  render();
                });
                document.getElementById('local-comment-clear').addEventListener('click', function(){
                  if(!confirm('确认清空本地所有留言？此操作不可恢复。')) return;
                  localStorage.removeItem(storageKey); render();
                });
                render();
              })();
            </script>
          {%- elsif site.comments_system == 'supabase' -%}
            <div id="comments" class="comment-panel">
              <h3>留言</h3>
              <div id="supabase-comments">
                <div id="supabase-comment-list" class="comment-list"></div>
                <div class="comment-row">
                  <textarea id="supabase-comment-input" class="comment-input" rows="4" placeholder="在此输入留言..."></textarea>
                </div>
                <div class="comment-row" style="margin-top:8px;">
                  <input id="supabase-comment-name" class="comment-name" placeholder="署名（可选）" />
                  <div style="display:flex; gap:8px;">
                    <button id="supabase-comment-submit" class="btn-primary">提交</button>
                  </div>
                </div>
                <div id="supabase-comment-status" class="comment-note">留言将匿名保存到远程数据库。</div>
                <div id="supabase-comment-error" class="comment-error" style="display:none;"></div>
              </div>
            </div>

            <script>
              (function(){
                var SUPABASE_URL = '{{ site.supabase_url | default: "" }}';
                var SUPABASE_ANON_KEY = '{{ site.supabase_anon_key | default: "" }}';
                var TABLE = '{{ site.supabase_table | default: "comments" }}';
                var RATE_LIMIT = Number('{{ site.supabase_rate_limit_seconds | default: 15 }}') || 15;
                try{
                  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
                    var errEl = document.getElementById('supabase-comment-error');
                    if(errEl){ errEl.style.display='block'; errEl.textContent = 'Supabase 未配置，请填写站点配置。'; }
                    console.warn('Supabase 未配置：supabase_url / supabase_anon_key');
                    return;
                  }
                }catch(e){ console.error('Supabase config check error', e); return; }

                function api(path, method, body){
                  return fetch(SUPABASE_URL + path, {
                    method: method,
                    headers: {
                      'Content-Type': 'application/json',
                      'apikey': SUPABASE_ANON_KEY,
                      'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
                    },
                    body: body ? JSON.stringify(body) : undefined
                  }).then(function(r){
                    // return both json and status for better error handling
                    return r.text().then(function(text){
                      var json = null;
                      try{ json = text ? JSON.parse(text) : null; }catch(e){ json = text; }
                      return { status: r.status, body: json };
                    });
                  });
                }

                function slug(){ return location.pathname; }

                function load(){
                  var q = '/rest/v1/' + TABLE + '?select=*&slug=eq.'+encodeURIComponent(slug())+'&order=created_at.desc';
                  return api(q, 'GET').then(function(r){ if(r.status>=200 && r.status<300) return r.body; throw r; });
                }

                function post(obj){
                  var q = '/rest/v1/' + TABLE + '?return=representation';
                  return api(q, 'POST', obj).then(function(r){ if(r.status>=200 && r.status<300) return r.body; throw r; });
                }

                function del(id){
                  var q = '/rest/v1/' + TABLE + '?id=eq.'+encodeURIComponent(id);
                  return api(q, 'DELETE').then(function(r){ if(r.status>=200 && r.status<300) return r.body; throw r; });
                }

                function formatTime(ts){ var d = new Date(ts); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+' '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }

                function render(list){
                  var container = document.getElementById('supabase-comment-list');
                  if(!container) return;
                  if(!list || list.length===0){ container.innerHTML = '<p style="color:#666;">还没有留言，写下你的第一条吧！</p>'; return; }
                  container.innerHTML = '';
                    list.forEach(function(item){
                      var div = document.createElement('div');
                      div.className = 'comment-item';
                      var initials = item.name ? item.name.trim().slice(0,1).toUpperCase() : '匿';
                      var author = item.name ? escapeHtml(item.name) : '匿名';
                      var time = item.created_at ? formatTime(item.created_at) : '';
                      div.innerHTML = '<div class="meta"><div class="meta-left"><div class="avatar-circle">'+initials+'</div><div><div class="comment-author">'+author+'</div><div class="comment-time">'+time+'</div></div></div></div>' +
                                  '<div class="comment-content">'+escapeHtml(item.content)+'</div>';
                    // add delete button if id exists
                    if(item.id){
                      var btn = document.createElement('button');
                      btn.className = 'btn-ghost';
                      btn.textContent = '删除';
                      btn.style.marginTop = '8px';
                      btn.addEventListener('click', function(){
                        if(!confirm('确认删除该评论？（如果删除失败，请在 Supabase 控制台删除）')) return;
                        del(item.id).then(function(resp){
                          // success, reload
                          load().then(function(res){ render(res); }).catch(function(e){ console.error(e); });
                        }).catch(function(err){
                          console.error('删除错误', err);
                          var errEl = document.getElementById('supabase-comment-error'); if(errEl){ errEl.style.display='block'; errEl.textContent='删除失败（可能没有权限），请在 Supabase 控制台删除'; }
                        });
                      });
                      var wrapper = document.createElement('div'); wrapper.style.marginTop='8px'; wrapper.appendChild(btn);
                      div.appendChild(wrapper);
                    }
                      container.appendChild(div);
                    });
                }

                function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

                // Load initial - run after DOM ready to avoid Edge timing issues
                function initLoad(){
                  load().then(function(res){ render(res); }).catch(function(e){ console.error(e); var errEl = document.getElementById('supabase-comment-error'); if(errEl){ errEl.style.display='block'; errEl.textContent='加载留言失败'; } });
                }
                if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initLoad); else initLoad();

                // Simple rate limit stored in sessionStorage
                function allowed(){ try{ var t = sessionStorage.getItem('supabase_last_post_' + slug()) || 0; return (Date.now() - Number(t)) / 1000 > RATE_LIMIT; }catch(e){ return true; } }
                function mark(){ try{ sessionStorage.setItem('supabase_last_post_' + slug(), String(Date.now())); }catch(e){} }

                var submitBtn = document.getElementById('supabase-comment-submit');
                if(submitBtn) submitBtn.addEventListener('click', function(){
                  if(!allowed()){ return alert('请稍后再发，防止刷屏'); }
                  var text = document.getElementById('supabase-comment-input').value.trim();
                  var name = document.getElementById('supabase-comment-name').value.trim();
                  if(!text) return alert('留言不能为空');
                  var payload = { slug: slug(), content: text, name: name || null };
                  post(payload).then(function(resp){
                    mark();
                    var input = document.getElementById('supabase-comment-input'); if(input) input.value='';
                    var nameInput = document.getElementById('supabase-comment-name'); if(nameInput) nameInput.value='';
                    var statusEl = document.getElementById('supabase-comment-status'); if(statusEl){ statusEl.textContent = '提交成功'; setTimeout(function(){ statusEl.textContent = '留言将匿名保存到远程数据库。'; }, 2000); }
                    // reload
                    load().then(function(res){ render(res); }).catch(function(e){ console.error(e); });
                  }).catch(function(err){
                    console.error('提交错误', err);
                    var errEl = document.getElementById('supabase-comment-error'); if(errEl){ errEl.style.display='block'; errEl.textContent='提交失败（网络或权限问题）'; }
                  });
                });

              })();
            </script>
          {%- endif -%}
        {%- endif -%}
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="wrapper">
      <div class="footer-content">
        <p>&copy; {{ site.time | date: '%Y' }} {{ site.title | escape }}. 用心记录，用爱分享。</p>
      </div>
    </div>
  </footer>

</body>
</html>
